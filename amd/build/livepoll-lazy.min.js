define(["jquery","core/log"],function(a,b){var c=this,d=function(){c.votes=[],a.each(c.options,function(a){c.votes[a]=0})},e=function(){c.listeningToClicks||(a(".livepoll-votebtn").on("click",function(){var b=a(this).data("option"),d={option:b},e=c.database.ref("polls/"+c.pollKey+"/votes/"+c.userKey);e.once("value").then(function(a){a.val()&&a.val().option===d.option?e.remove():e.set(d)})}),c.listeningToClicks=!0)},f=function(){a("#livepoll_closevoting").on("change",function(){var a=this.checked,b=c.database.ref("polls/"+c.pollKey+"/controls/closeVoting");b.set(a)}),a("#livepoll_highlightanswer").on("change",function(){var a=this.checked,b=c.database.ref("polls/"+c.pollKey+"/controls/higlightAnswer");b.set(a)}),c.closeVoting||(a(".livepoll-votebtn").removeClass("disabled"),e())},g=function(){c.listeningToClicks&&(a(".livepoll-votebtn").off("click"),c.listeningToClicks=!1)},h=function(){var d=[];a.each(c.resultHandlers,function(a,b){var e=b.update(c.options,c.votes);d.push(e)}),a.when.apply(a,d).done(function(){b.debug("livepoll UI has been updated.")})},i=function(){var b=c.database.ref("polls/"+c.pollKey+"/votes");b.once("value").then(function(b){var e=b.val();d(),a(".livepoll-votebtn").addClass("btn-primary").removeClass("btn-success"),a.each(e,function(b,d){c.votes[d.option]++,b===c.userKey&&a('.livepoll-votebtn[data-option="'+d.option+'"]').addClass("btn-success").removeClass("btn-primary")}),h()})},j=function(){var b=c.database.ref("polls/"+c.pollKey+"/controls");b.once("value").then(function(b){var d=b.val();c.closeVoting=!!d.closeVoting,c.higlightAnswer=!!d.higlightAnswer,a("#livepoll_closevoting").prop("checked",c.closeVoting),a("#livepoll_highlightanswer").prop("checked",c.higlightAnswer),a(".livepoll-votebtn").toggleClass("disabled",c.closeVoting),c.closeVoting?g():e(),a(".livepoll-votebtn").removeClass("answer"),c.higlightAnswer&&a('.livepoll-votebtn[data-option="'+c.correctOption+'"]').addClass("answer")})},k=function(){var a=c.database.ref("polls/"+c.pollKey+"/votes");a.on("child_added",i),a.on("child_changed",i),a.on("child_removed",i);var b=c.database.ref("polls/"+c.pollKey+"/controls");b.on("child_added",j),b.on("child_changed",j),b.on("child_removed",j),h()},l=function(){var b=a.Deferred(),d=[];c.resultHandlers=[];var e=["green","bold","shadowy"];return a.each(c.resultsToRender,function(b,f){var g=a.Deferred();require(["mod_livepoll/"+f+"-result-lazy"],function(b){if("text"===f){var d=new b,h=[];a.each(e,function(b,c){var e=a.Deferred();h.push(e.promise()),require(["mod_livepoll/"+c+"-text-result-lazy"],function(a){d=new a(d),e.resolve()})}),a.when.apply(a,h).done(function(){c.resultHandlers.push(d),g.resolve()})}else c.resultHandlers.push(new b),g.resolve()}),d.push(g.promise())}),a.when.apply(a,d).done(function(){b.resolve()}),b.promise()},m=function(){var a={apiKey:c.apiKey,authDomain:c.projectID+".firebaseapp.com",databaseURL:"https://"+c.projectID+".firebaseio.com",storageBucket:c.projectID+".appspot.com"};c.firebase.initializeApp(a),c.database=c.firebase.database(),c.auth=c.firebase.auth(),c.auth.signInAnonymously()["catch"](function(a){var c=a.code,d=a.message;b.error("Could not authenticate into firebase using anonymous setup."),b.error(c),b.error(d)}),c.auth.onAuthStateChanged(function(a){a?(b.debug("User has signed in to firebase."),c.fbuser=a,l().done(function(){k(),f()})):b.debug("User has signed out from firebase.")})},n=function(e,f,g,h,i,j,k){c.apiKey=e,c.projectID=f,c.options=i,c.correctOption=j,c.pollKey=g,c.userKey=h,c.resultsToRender=k,c.closeVoting=!1,c.higlightAnswer=!1,c.listeningToClicks=!1,d(),a(document).ready(function(){return void 0===firebase?void b.error("Firebase not found. Live poll will not work."):(c.firebase=firebase,void m())})};return{init:n}});