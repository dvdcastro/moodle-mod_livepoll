define(["jquery","core/log"],function(a,b){var c=this,d=function(d,g,h,i,j,k,l){c.apiKey=d,c.projectID=g,c.options=j,c.correctOption=k,c.pollKey=h,c.userKey=i,c.resultsToRender=l,e(),a(document).ready(function(){return void 0===firebase?void b.error("Firebase not found. Live poll will not work."):(c.firebase=firebase,void f())})},e=function(){c.votes=[],a.each(c.options,function(a){c.votes[a]=0})},f=function(){var a={apiKey:c.apiKey,authDomain:c.projectID+".firebaseapp.com",databaseURL:"https://"+c.projectID+".firebaseio.com",storageBucket:c.projectID+".appspot.com"};c.firebase.initializeApp(a),c.database=c.firebase.database(),c.auth=c.firebase.auth(),c.auth.signInAnonymously()["catch"](function(a){var c=a.code,d=a.message;b.error("Could not authenticate into firebase using anonymous setup."),b.error(c),b.error(d)}),c.auth.onAuthStateChanged(function(a){a?(c.fbuser=a,j().done(function(){g(),h()})):b.error("User has signed out from firebase.")})},g=function(){var a=c.database.ref("polls/"+c.pollKey);a.on("child_added",i),a.on("child_changed",i),a.on("child_removed",i),k()},h=function(){a(".livepoll-votebtn").on("click",function(){var b=a(this).data("option"),d={option:b},e=c.database.ref("polls/"+c.pollKey+"/votes/"+c.userKey);e.once("value").then(function(a){a.val()&&a.val().option===d.option?e.remove():e.set(d)})}).removeClass("disabled")},i=function(b){var d=b.val();e(),a(".livepoll-votebtn").addClass("btn-primary").removeClass("btn-success"),a.each(d,function(b,d){c.votes[d.option]++,b===c.userKey&&a('.livepoll-votebtn[data-option="'+d.option+'"]').addClass("btn-success").removeClass("btn-primary")}),k()},j=function(){var b=a.Deferred(),d=[];c.resultHandlers=[];var e=["green","bold","shadowy"];return a.each(c.resultsToRender,function(b,f){var g=a.Deferred();require(["mod_livepoll/"+f+"-result-lazy"],function(b){if("text"===f){var d=new b,h=[];a.each(e,function(b,c){var e=a.Deferred();h.push(e.promise()),require(["mod_livepoll/"+c+"-text-result-lazy"],function(a){d=new a(d),e.resolve()})}),a.when.apply(a,h).done(function(){c.resultHandlers.push(d),g.resolve()})}else c.resultHandlers.push(new b),g.resolve()}),d.push(g.promise())}),a.when.apply(a,d).done(function(){b.resolve()}),b.promise()},k=function(){var d=[];a.each(c.resultHandlers,function(a,b){var e=b.update(c.options,c.votes);d.push(e)}),a.when.apply(a,d).done(function(){b.debug("livepoll UI has been updated.")})};return{init:d}});