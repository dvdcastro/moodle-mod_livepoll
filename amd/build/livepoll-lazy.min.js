define(["jquery","core/log"],function(a,b){var c=this,d=function(d,g,h,i,j,k){c.apiKey=d,c.projectID=g,c.options=j,c.correctOption=k,c.pollKey=h,c.userKey=i,e(),a(document).ready(function(){return void 0===firebase?void b.error("Firebase not found. Live poll will not work."):(c.firebase=firebase,void f())})},e=function(){c.votes=[],a.each(c.options,function(a){c.votes[a]=0})},f=function(){var a={apiKey:c.apiKey,authDomain:c.projectID+".firebaseapp.com",databaseURL:"https://"+c.projectID+".firebaseio.com",storageBucket:c.projectID+".appspot.com"};c.firebase.initializeApp(a),c.database=c.firebase.database(),c.auth=c.firebase.auth(),c.auth.onAuthStateChanged(function(a){a?c.fbuser=a:c.auth.signInAnonymously(),j().done(function(){g(),h()})})},g=function(){var a=c.database.ref("polls/"+c.pollKey);a.on("child_added",i),a.on("child_changed",i),a.on("child_removed",i),k()},h=function(){a(".livepoll-votebtn").on("click",function(){var b=a(this).data("option"),d={option:b},e=c.database.ref("polls/"+c.pollKey+"/votes/"+c.userKey);e.set(d)}).removeClass("disabled")},i=function(b){var d=b.val();e(),a.each(d,function(b,d){c.votes[d.option]++,b===c.userKey&&(a(".livepoll-votebtn").addClass("btn-primary").removeClass("btn-success"),a('.livepoll-votebtn[data-option="'+d.option+'"]').addClass("btn-success").removeClass("btn-primary"))}),k()},j=function(){var b=a.Deferred(),d=[],e=["barchart","text"];return c.resultHandlers=[],a.each(e,function(b,e){var f=a.Deferred();require(["mod_livepoll/"+e+"-result-lazy"],function(a){c.resultHandlers.push(new a),f.resolve()}),d.push(f.promise())}),a.when.apply(a,d).done(function(){b.resolve()}),b.promise()},k=function(){var d=[];a.each(c.resultHandlers,function(a,b){var e=b.update(c.options,c.votes);d.push(e)}),a.when.apply(a,d).done(function(){b.debug("livepoll UI has been updated.")})};return{init:d}});